<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A few thoughts you're free to ignore"><link rel="shortcut icon" href=https://randthoughts.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Random wallpaper with just bash and systemd</title></head><body><header id=banner><h2><a href=https://randthoughts.github.io/>Random thoughts</a></h2><nav><ul><li><a href=/about/ title=About>about</a></li></ul></nav><div id=description>A few thoughts you're free to ignore</div></header><main id=content><article><header id=post-header><h1>Random wallpaper with just bash and systemd</h1><div><time>July 21, 2022</time></div></header><p>I&rsquo;m a big fan of <a href=https://peterlevi.com/variety/>Variety</a>, probably the most popular wallpaper changer among Linux users. It&rsquo;s been sitting in my GNOME desktop&rsquo;s system tray for a long time. (Yes, I know GNOME doesn&rsquo;t actually have a system tray, but I can&rsquo;t live without it so I installed Ubuntu&rsquo;s <em>AppIndicator and KStatusNotifierItem Support</em> extension).</p><p>Recently, Variety started having some hiccups, for the simple reason that the API key used for fetching images from Unsplash is shared among <em>all</em> Variety users, which means API rate limits are often <a href=https://github.com/varietywalls/variety/issues/332>exceeded</a>. Since I don&rsquo;t use most of Variety&rsquo;s features and I have only Unsplash enabled as image source, I scratched an itch by writing my own little wallpaper changer. Truth be told, it&rsquo;s nothing fancy, but it does the job.</p><p>Here&rsquo;s the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>set -o errexit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># What? Associative arrays?</span>
</span></span><span style=display:flex><span>declare -A topics
</span></span><span style=display:flex><span>topics<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>current_events<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;BJJMtteDJA4&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>wallpapers<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;bo8jQKTaE0Y&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>3d_renders<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;CDwuwXJAbEw&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>textures_and_patterns<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;iUIsnVtjB0Y&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>experimental<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;qPYsDzvJOYc&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>architecture<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;rnSKDHwwYUk&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>nature<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;6sMVjTLSkeQ&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>business_and_work<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;aeu6rL-j6ew&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>fashion<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;S4MKLAsBB74&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>film<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;hmenvQhUmxM&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>api_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://api.unsplash.com/photos/random?orientation=landscape&amp;topics=&#34;</span>
</span></span><span style=display:flex><span>access_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR_API_KEY&#34;</span>
</span></span><span style=display:flex><span>images_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span><span style=color:#e6db74>/Pictures/wallchanger&#34;</span>
</span></span><span style=display:flex><span>image_prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wallchanger_&#34;</span>
</span></span><span style=display:flex><span>my_topics<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;wallpapers&#34;</span> <span style=color:#e6db74>&#34;nature&#34;</span> <span style=color:#e6db74>&#34;architecture&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>delete_older_than_days<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Delete images older than X days</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>images_dir<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>image_prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>*.jpg&#34;</span> -mtime <span style=color:#e6db74>&#34;+</span><span style=color:#e6db74>${</span>delete_older_than_days<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -exec rm --force <span style=color:#e6db74>&#39;{}&#39;</span> +
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>image_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>images_dir<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>image_prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>XXXXXXXXXX.jpg&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build request URL with comma-separated topics</span>
</span></span><span style=display:flex><span>request_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>api_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> topic in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>my_topics[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  request_url<span style=color:#f92672>+=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>topics[$topic]<span style=color:#e6db74>}</span><span style=color:#e6db74>%2C&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>image_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>curl --silent --show-error --header <span style=color:#e6db74>&#34;Authorization: Client-ID </span><span style=color:#e6db74>${</span>access_key<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>request_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | jq --raw-output <span style=color:#e6db74>&#34;.links.download&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>curl --silent --show-error --location --header <span style=color:#e6db74>&#34;Authorization: Client-ID </span><span style=color:#e6db74>${</span>access_key<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --output <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>image_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>image_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set as light, dark and lockscreen wallpaper regardless of current mode</span>
</span></span><span style=display:flex><span>gsettings set <span style=color:#e6db74>&#34;org.gnome.desktop.background&#34;</span> <span style=color:#e6db74>&#34;picture-uri&#34;</span> <span style=color:#e6db74>&#34;file:///</span><span style=color:#e6db74>${</span>image_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>gsettings set <span style=color:#e6db74>&#34;org.gnome.desktop.background&#34;</span> <span style=color:#e6db74>&#34;picture-uri-dark&#34;</span> <span style=color:#e6db74>&#34;file:///</span><span style=color:#e6db74>${</span>image_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>gsettings set <span style=color:#e6db74>&#34;org.gnome.desktop.screensaver&#34;</span> <span style=color:#e6db74>&#34;picture-uri&#34;</span> <span style=color:#e6db74>&#34;file:///</span><span style=color:#e6db74>${</span>image_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>I know, I cheated. But you know what? Grepping JSON data ain&rsquo;t no fun, and I&rsquo;ve <code>jq</code> already installed on my machine (who hasn&rsquo;t, by the way?).</p><p>If you&rsquo;re interested in a different set of topics, you can change the <code>my_topics</code> array to include any of the keys in the <code>topics</code> array. I personally don&rsquo;t like my home folder growing indefinitely, so the script deletes images older than <code>$delete_older_than_days</code>. If there&rsquo;s a wallpaper that I like particularly, I should have enough time to make a copy of it.</p><p>I use this script with GNOME but it should work on other DEs as well, barring minor modifications. It&rsquo;s worth noting that both light and dark wallpapers are changed, regardless of which theme mode is currently in use. To keep things consistent, the wallpaper of the lockscreen is also changed.</p><p>Anyway, we&rsquo;ve done only half of the job, as the script alone doesn&rsquo;t automate wallpaper switching. The standard way of achieving that is a systemd service/timer combo. Since we&rsquo;re only interested in running the script as regular, non-root user, unit files can be conveniently installed under <code>~/.config/systemd/user</code>. Here is the service unit I use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#75715e># ~/.config/systemd/user/wallchanger.service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Change GNOME wallpaper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/path/to/wallchanger.sh</span>
</span></span></code></pre></div><p>Of course, replace <code>/path/to/wallchanger.sh</code> with whatever the script&rsquo;s path is. As mentioned, we also need a timer unit, which is responsible for the actual automation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#75715e># ~/.config/systemd/user/wallchanger.timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Start wallchanger.service hourly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Timer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>OnCalendar</span><span style=color:#f92672>=</span><span style=color:#e6db74>hourly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>timers.target</span>
</span></span></code></pre></div><p>Notice that for this to work, the two unit files must have the same name (except for the <code>.timer</code>/<code>.service</code> suffix). You can change <code>hourly</code> to your preferred interval; for example, to switch wallpaper once a day, you can put <code>daily</code>. Systemd has its own syntax for specifying schedules, which is well <a href=https://www.freedesktop.org/software/systemd/man/systemd.time.html>documented</a>.</p><p>Once everything is in place, we need to tell systemd to reload its configuration with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user daemon-reload
</span></span></code></pre></div><p>Now, it&rsquo;s time to test the service unit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user start wallchanger.service
</span></span></code></pre></div><p>If you don&rsquo;t see any output, don&rsquo;t despair, that&rsquo;s the expected outcome! Actually, your desktop&rsquo;s wallpaper should have already changed by now. If that&rsquo;s not the case, you can inspect what&rsquo;s going on with journalctl (add <code>--follow</code> to monitor the unit in realtime):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>journalctl --user --unit wallchanger.service
</span></span></code></pre></div><p>Lastly, we need to enable and start the timer so that it&rsquo;s preseved across reboots:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable --now wallchanger.timer
</span></span></code></pre></div><p>Enough wasted time for today. If you really want to use my ugly script, make sure you get an <a href=https://unsplash.com/developers>API key</a> from Unsplash. The default, free, &ldquo;demo&rdquo; mode is capped at 50 requests per hour, which is more than enough for this use case&mldr; Right?</p></article></main><footer id=footer></footer></body></html>