<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A few thoughts you're free to ignore"><link rel="shortcut icon" href=https://randthoughts.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Random wallpaper with just bash and systemd</title></head><body><header id=banner><h2><a href=https://randthoughts.github.io/>Random thoughts</a></h2><nav><ul><li><a href=/contact/ title=Contact>contact</a></li></ul></nav><div id=description>A few thoughts you're free to ignore</div></header><main id=content><article><header id=post-header><h1>Random wallpaper with just bash and systemd</h1><div><time>July 21, 2022</time></div></header><p>I&rsquo;m a big fan of Variety<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, probably the most popular wallpaper changer among Linux users. It&rsquo;s been sitting in my GNOME desktop&rsquo;s system tray for a long time. (Yes, I know GNOME doesn&rsquo;t actually have a system tray, but I can&rsquo;t live without it so I installed Ubuntu&rsquo;s <em>AppIndicator and KStatusNotifierItem Support</em> extension).</p><p>Recently, Variety started having some hiccups, for the simple reason that the API key it uses for Unsplash is shared among all Variety&rsquo;s users, thus incurring rate limiting<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Since I don&rsquo;t use most of Variety&rsquo;s features, and I have only Unsplash enabled as image source, I scratched an itch by writing my own little wallpaper changer. Truth be told, it&rsquo;s nothing fancy, but it does the job.</p><p>Here&rsquo;s the Bash script (be sure to <code>chmod +x</code> it before running):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/usr/bin/env bash
</span><span style=color:#75715e></span>
ACCESS_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR-UNSPLASH-ACCESS-KEY&#34;</span>
TOPIC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bo8jQKTaE0Y&#34;</span> <span style=color:#75715e># &#34;Wallpapers&#34;</span>
WALLPAPER_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span><span style=color:#e6db74>/.local/share/backgrounds&#34;</span>

<span style=color:#66d9ef>if</span> ! photo_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>WALLPAPER_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;unsplash.com.XXXXXXXXXX.jpg&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>then</span>
  &gt;&amp;<span style=color:#ae81ff>2</span> echo <span style=color:#e6db74>&#34;Error: failed to create temporary file.&#34;</span>
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> ! photo_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>curl --silent --show-error --header <span style=color:#e6db74>&#34;Authorization: Client-ID </span><span style=color:#e6db74>${</span>ACCESS_KEY<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;https://api.unsplash.com/photos/random?orientation=landscape&amp;topic=</span><span style=color:#e6db74>${</span>TOPIC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  | grep --ignore-case --only-matching --perl-regexp <span style=color:#e6db74>&#39;(?&lt;=download&#34;:&#34;).*?(?=&#34;)&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>then</span>
  &gt;&amp;<span style=color:#ae81ff>2</span> echo <span style=color:#e6db74>&#34;Error: failed to retrieve download URL.&#34;</span>
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> ! curl --silent --show-error --location --header <span style=color:#e6db74>&#34;Authorization: Client-ID </span><span style=color:#e6db74>${</span>ACCESS_KEY<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --output <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>photo_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>photo_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>then</span>
  &gt;&amp;<span style=color:#ae81ff>2</span> echo <span style=color:#e6db74>&#34;Error: failed to download photo.&#34;</span>
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>for</span> setting_name in <span style=color:#e6db74>&#34;background&#34;</span> <span style=color:#e6db74>&#34;screensaver&#34;</span>; <span style=color:#66d9ef>do</span>
  <span style=color:#66d9ef>if</span> ! gsettings set <span style=color:#e6db74>&#34;org.gnome.desktop.</span><span style=color:#e6db74>${</span>setting_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;picture-uri&#34;</span> <span style=color:#e6db74>&#34;file:///</span><span style=color:#e6db74>${</span>photo_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
  <span style=color:#66d9ef>then</span>
    &gt;&amp;<span style=color:#ae81ff>2</span> echo <span style=color:#e6db74>&#34;Error: failed to set photo as </span><span style=color:#e6db74>${</span>setting_name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>
    exit <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>done</span>
</code></pre></div><p>As you can see, it does nothing more than downloading a random picture from Unplash&rsquo;s <em>Wallpapers</em> topic, saving it to the user&rsquo;s default backgrounds directory, and setting it as GNOME wallpaper. Additionally, it sets the picture as screen saver, so that it is displayed in the lock screen as well. One thing that could be added is purging old image files based on their modification time. This way, the backgrounds directory doesn&rsquo;t grown boundlessly. For now, I&rsquo;ll leave it as is.</p><p>Of course, the above script assumes that you use GNOME as desktop environment, and that you have obtained an API key from Unsplash<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. The default, free &ldquo;demo&rdquo; mode is capped at 50 requests per hour, which is more than enough for this use case&mldr; Right?</p><p>If you prefer other topic(s) to pull photos from, here are their respective IDs:</p><ul><li><em>Current Events</em>: <code>BJJMtteDJA4</code></li><li><em>Wallpapers</em>: <code>bo8jQKTaE0Y</code> (the one I use)</li><li><em>3D Renders</em>: <code>CDwuwXJAbEw</code></li><li><em>Textures & Patterns</em>: <code>iUIsnVtjB0Y</code></li><li><em>Experimental</em>: <code>qPYsDzvJOYc</code></li><li><em>Architecture</em>: <code>rnSKDHwwYUk</code></li><li><em>Nature</em>: <code>6sMVjTLSkeQ</code></li><li><em>Business & Work</em>: <code>aeu6rL-j6ew</code></li><li><em>Fashion</em>: <code>S4MKLAsBB74</code></li><li><em>Film</em>: <code>hmenvQhUmxM</code></li></ul><p>Actually, you don&rsquo;t even <em>have</em> to choose a topic. The ways in which the pool of photos can be narrowed down are explained in Unsplash&rsquo;s API docs<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>Anyway, we&rsquo;ve done only half of the job, as the script alone doesn&rsquo;t automate wallpaper switching. The standard way of achieving that is a systemd service/timer combo. Since we&rsquo;re only interested in running the script as regular, non-root user, unit files can be conveniently installed under <code>~/.config/systemd/user</code>. Here is the service unit I use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=color:#75715e># ~/.config/systemd/user/wallchanger.service</span>
<span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Change GNOME wallpaper</span>

<span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/path/to/wallchanger.sh</span>
</code></pre></div><p>Of course, replace <code>/path/to/wallchanger.sh</code> with whatever the script&rsquo;s path is. As mentioned, we also need a timer unit, which is responsible for the actual automation:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=color:#75715e># ~/.config/systemd/user/wallchanger.timer</span>
<span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Start wallchanger.service hourly</span>

<span style=color:#66d9ef>[Timer]</span>
<span style=color:#a6e22e>OnCalendar</span><span style=color:#f92672>=</span><span style=color:#e6db74>hourly</span>

<span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>timers.target</span>
</code></pre></div><p>Notice that for this to work, the two unit files must have the same name (except for the <code>.timer</code>/<code>.service</code> suffix). You can change <code>hourly</code> to your preferred interval; for example, to switch wallpaper once a day, you can put <code>daily</code>. Systemd has its own way of specifying times and dates, so if you need something more complex, I encourage you to check systemd&rsquo;s documentation<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.</p><p>Once everything is in place, we need to tell systemd to reload its configuration with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl --user daemon-reload
</code></pre></div><p>Now, it&rsquo;s time to test the service unit:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl --user start wallchanger.service
</code></pre></div><p>If you don&rsquo;t see any output, don&rsquo;t despair, that&rsquo;s the expected outcome! Actually, your desktop&rsquo;s wallpaper should have already changed by now. If that&rsquo;s not the case, you can inspect what&rsquo;s going on with journalctl (add <code>--follow</code> to monitor the unit in realtime):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>journalctl --user --unit wallchanger.service
</code></pre></div><p>Lastly, we need to enable and start the timer so that it is preseved across reboots:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable --now wallchanger.timer
</code></pre></div><p>That&rsquo;s all folks!</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://peterlevi.com/variety/>https://peterlevi.com/variety/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://github.com/varietywalls/variety/issues/332>https://github.com/varietywalls/variety/issues/332</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://unsplash.com/developers>https://unsplash.com/developers</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://unsplash.com/documentation#get-a-random-photo>https://unsplash.com/documentation#get-a-random-photo</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p><a href=https://www.freedesktop.org/software/systemd/man/systemd.time.html>https://www.freedesktop.org/software/systemd/man/systemd.time.html</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article></main><footer id=footer>Copyright &copy; 2022 Random thoughts &bull; Theme by <a href=https://lukasjoswiak.com/>Lukas Joswiak</a> &bull; Made with <a href=https://gohugo.io/>Hugo</a></footer></body></html>